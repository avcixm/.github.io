name: Sync public pages to private CV

on:
  push:
    branches: [ main ]
    paths:
      - 'index.md'
      - 'teaching.md'
      - 'research.md'
      - 'supervision.md'
      - 'service_contributions.md'
      - 'professional_activities.md'
  workflow_dispatch:

jobs:
  build-cv:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout public site repo
        uses: actions/checkout@v4

      - name: Build cv.md from page sections (safe Python)
        run: |
          python3 - <<'PY'
          import re, pathlib

          def grab(path, start, end):
              p = pathlib.Path(path)
              if not p.exists():
                  return ''
              s = p.read_text(encoding='utf-8')
              m = re.search(re.escape(start)+r'(.*?)'+re.escape(end), s, re.S)
              return (m.group(1).strip() if m else '')

          home  = grab('index.md',                    '<!-- CV:START HOME -->',        '<!-- CV:END HOME -->')
          teach = grab('teaching.md',                 '<!-- CV:START TEACHING -->',    '<!-- CV:END TEACHING -->')
          rsrch = grab('research.md',                 '<!-- CV:START RESEARCH -->',    '<!-- CV:END RESEARCH -->')
          supv  = grab('supervision.md',              '<!-- CV:START SUPERVISION -->', '<!-- CV:END SUPERVISION -->')
          serv  = grab('service_contributions.md',    '<!-- CV:START SERVICE -->',     '<!-- CV:END SERVICE -->')
          prof  = grab('professional_activities.md',  '<!-- CV:START PROFESSIONAL -->','<!-- CV:END PROFESSIONAL -->')

          tpl = f"""---
title: Curriculum Vitae — Mustafa Avci
---

# Mustafa Avci
Department of Mathematics, Athabasca University  
mavci@athabascau.ca · https://avcixm.github.io/academicprofile/

## Summary
{home}

## Research
{rsrch}

## Teaching
{teach}

## Supervision
{supv}

## Service & Contributions
{serv}

## Professional Activities
{prof}
"""
          out = pathlib.Path('out'); out.mkdir(exist_ok=True)
          (out/'cv.md').write_text(tpl, encoding='utf-8')
          print("Wrote out/cv.md")
          PY

      - name: Checkout PRIVATE cv repo
        uses: actions/checkout@v4
        with:
          repository: avcixm/cv-private
          token: ${{ secrets.CV_PRIVATE_PAT }}
          path: cvrepo

      - name: Update cv.md in private repo
        run: |
          cp out/cv.md cvrepo/cv.md
          cd cvrepo
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add cv.md
          git commit -m "Sync from public site ${GITHUB_SHA}" || echo "No changes"
          git push
